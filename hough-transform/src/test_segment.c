#include <stdlib.h>
#include "segment.h"

void create_test_status_data(tim571_status_data *data)
{
  data->firmware_version = 1;
  data->sopas_device_id = 1;
  data->serial_number = 18150133;
  data->error = 0;
  data->scanning_frequency = 1500;
  data->scanning_frequency = 1500;
  data->multiplier = 1.000;
  data->starting_angle = -450000;
  data->angular_step = 3333;
  data->data_count = 811;
  data->rssi_available = 1;
}

void create_test_distance(uint16_t *distance)
{
  uint16_t dump[] = {
    2586, 2590, 2596, 2590, 2593, 2586, 2590, 2593, 2587, 2591,
    2594, 2589, 2588, 2589, 2591, 2591, 2594, 2595, 2598, 2596,
    2597, 2597, 2604, 2599, 2605, 2603, 2606, 2608, 2610, 2610,
    2612, 2620, 2622, 2621, 2625, 2629, 2629, 2632, 2632, 2637,
    2646, 2647, 2653, 2654, 2657, 2662, 2665, 2668, 2676, 2679,
    2683, 2685, 2686, 2695, 2695, 2708, 2705, 2715, 2720, 2722,
    2729, 2735, 2739, 2744, 2751, 2760, 2765, 2770, 2776, 2784,
    2787, 2794, 2802, 2807, 2819, 2824, 2830, 2837, 2844, 2851,
    2858, 2870, 2875, 2884, 2892, 2898, 2910, 2921, 2927, 2936,
    2947, 2956, 2964, 2974, 2983, 2991, 3001, 3012, 3022, 3034,
    3045, 3053, 3069, 3092, 3104, 3116, 3128, 3140, 3144, 3162,
    3177, 3186, 3201, 3215, 3226, 3238, 3250, 3267, 3251, 3247,
    3284, 3297, 3327, 3346, 3364, 3380, 3404, 3418, 3424, 3404,
    3374, 3352, 3333, 3308, 3291, 3264, 3247, 3228, 3204, 3185,
    3168, 3150, 3132, 3111, 3096, 3079, 3060, 3044, 3025, 3006,
    2994, 2974, 2960, 2944, 2929, 2911, 2901, 2882, 2870, 2856,
    2839, 2829, 2815, 2802, 2790, 2775, 2769, 2753, 2742, 2726,
    2718, 2704, 2692, 2684, 2675, 2663, 2650, 2642, 2631, 2621,
    2610, 2598, 2591, 2584, 2572, 2563, 2556, 2545, 2537, 2528,
    2522, 2515, 2510, 2499, 2488, 2484, 2476, 2468, 2462, 2452,
    2448, 2443, 2434, 2426, 2419, 2413, 2408, 2400, 2394, 2387,
    2384, 2376, 2372, 2365, 2361, 2357, 2354, 2348, 2337, 2335,
    2332, 2325, 2323, 2315, 2312, 2308, 2305, 2301, 2306, 2309,
    2305, 2301, 2298, 2292, 2289, 2286, 2280, 2276, 2271, 2265,
    2264, 2264, 2261, 2257, 2250, 2249, 2245, 2245, 2236, 2235,
    2232, 2232, 2226, 2225, 2221, 2219, 2216, 2214, 2210, 2209,
    2209, 2206, 2206, 2231, 2256, 2267, 2251, 2253, 2255, 2242,
    2251, 2247, 2250, 2249, 2238, 2251, 2245, 2255, 2251, 2245,
    2247, 2257, 2251, 2244, 2253, 2256, 2256, 2250, 2251, 2255,
    2259, 2262, 2459, 2833, 4494, 4496, 2803, 2520, 2388, 2331,
    2330, 2331, 2331, 2336, 2336, 2340, 2337, 2342, 2344, 2343,
    2345, 2349, 2351, 2354, 2358, 2359, 2362, 2359, 2369, 2368,
    2370, 2373, 2373, 2380, 2381, 2384, 2393, 2414, 2546, 4256,
    4267, 4273, 4280, 4561, 4709, 4721, 4717, 4676, 4454, 4491,
    4486, 4505, 4587, 4516, 4590, 4582, 4626, 4540, 3125, 3267,
    3261, 3269, 3184, 4721, 4690, 4717, 4706, 4715, 4736, 4763,
    4761, 4787, 4720, 4624, 4629, 4640, 4657, 4671, 4686, 4704,
    4719, 4735, 4748, 4769, 4777, 4766, 4725, 4669, 4630, 4585,
    4544, 4501, 4469, 4431, 4392, 4355, 4324, 4286, 4261, 4353,
    4415, 4372, 4339, 4299, 4284, 4303, 4321, 4339, 4351, 4356,
    4371, 4380, 4374, 4341, 2873, 3024, 3041, 3058, 3073, 3092,
    3113, 3129, 3148, 3168, 3185, 3209, 3224, 3245, 3267, 3284,
    3306, 3327, 3349, 3363, 3398, 3417, 3439, 3467, 3487, 3514,
    3539, 3571, 3596, 3624, 3653, 3680, 3707, 3734, 3767, 3797,
    3825, 3864, 3897, 3902, 3888, 3867, 3857, 3836, 3823, 3810,
    3793, 3777, 3765, 3753, 3735, 3722, 3712, 3701, 3689, 3675,
    3663, 3649, 3636, 3626, 3617, 3607, 3596, 3582, 3572, 3560,
    3552, 3540, 3532, 3520, 3515, 3524, 3520, 3510, 3499, 3488,
    3483, 3475, 3464, 3457, 3446, 3441, 3434, 3426, 3416, 3410,
    3405, 3397, 3387, 3380, 3378, 3370, 3363, 3353, 3350, 3343,
    3336, 3332, 3327, 3317, 3319, 3310, 3313, 3302, 3298, 3294,
    3290, 3281, 3277, 3278, 3269, 3263, 3263, 3255, 3256, 3252,
    3243, 3248, 3237, 3238, 3231, 3228, 3228, 3226, 3221, 3216,
    3215, 3210, 3217, 3207, 3206, 3199, 3202, 3196, 3198, 3197,
    3199, 3189, 3187, 3192, 3191, 3189, 3186, 3188, 3190, 3187,
    3188, 3186, 3185, 3184, 3184, 3187, 3186, 3184, 3187, 3188,
    3190, 3192, 3189, 3191, 3196, 3194, 3193, 3196, 3198, 3196,
    3198, 3204, 3203, 3204, 3210, 3207, 3209, 3217, 3218, 3220,
    3222, 3226, 3226, 3232, 3231, 3235, 3240, 3246, 3249, 3252,
    3254, 3255, 3263, 3263, 3266, 3272, 3279, 3282, 3288, 3294,
    3302, 3307, 3307, 3315, 3323, 3283, 3160, 3099, 3046, 2994,
    2940, 2897, 2851, 2802, 2764, 2719, 2675, 2638, 2598, 2564,
    2528, 2493, 2463, 2429, 2397, 2366, 2342, 2309, 2280, 2255,
    2228, 2194, 2093, 1997, 1968, 1947, 1924, 1901, 1882, 1861,
    1838, 1822, 1800, 1782, 1763, 1747, 1730, 1712, 1697, 1678,
    1665, 1650, 1632, 1616, 1607, 1590, 1578, 1566, 1552, 1538,
    1525, 1512, 1500, 1488, 1477, 1466, 1453, 1440, 1434, 1422,
    1412, 1402, 1390, 1378, 1371, 1362, 1353, 1342, 1334, 1323,
    1314, 1307, 1292, 1288, 1292, 1277, 1269, 1255, 1248, 1247,
    1238, 1234, 1222, 1209, 1205, 1199, 1199, 1190, 1189, 1173,
    1169, 1174, 1164, 1161, 1153, 1145, 1137, 1136, 1135, 1123,
    1122, 1118, 1106, 1103, 1101, 1092, 1085, 1078, 1074, 1079,
    1072, 1069, 1072, 1059, 1051, 1049, 1055, 1042, 1031, 1028,
    1038, 1021, 1023, 1022, 1020, 1017, 1012, 1003, 1001, 998,
    1001, 1004, 996, 996, 1004, 1023, 1028, 1044, 1054, 1065,
    1082, 1095, 2, 2057, 2078, 2113, 2140, 2126, 2115, 0,
    0, 0, 0, 2, 0, 0, 0, 0, 0, 2,
    2, 2693, 2740, 2767, 2797, 2817, 2816, 2814, 2810, 2807,
    2800, 2793, 2791, 2788, 2780, 2779, 2770, 2768, 2762, 2759,
    2759, 1878, 1878, 1873, 1881, 1910, 1891, 0, 2730, 2731,
    2730, 0, 2, 105, 146, 135, 57, 0, 0, 105,
    0
  };
  for (int index = 0; index < TIM571_DATA_COUNT; index++) {
    distance[index] = dump[index];
  }
}

void create_test_rssi(uint8_t *rssi)
{
  uint16_t dump[] = {
    0, 0, 48, 5, 43, 166, 174, 188, 205, 230,
    230, 230, 230, 211, 197, 191, 183, 177, 169, 163,
    160, 157, 152, 155, 149, 149, 146, 149, 146, 149,
    146, 143, 143, 140, 143, 143, 143, 143, 138, 138,
    140, 143, 140, 138, 140, 140, 143, 138, 140, 138,
    140, 140, 140, 138, 143, 138, 135, 135, 135, 140,
    135, 138, 140, 135, 138, 140, 135, 135, 135, 135,
    135, 132, 135, 129, 135, 129, 138, 135, 135, 132,
    135, 135, 132, 132, 129, 132, 132, 132, 126, 132,
    132, 132, 132, 129, 129, 126, 135, 126, 129, 129,
    129, 129, 126, 129, 126, 129, 126, 124, 126, 124,
    126, 132, 135, 95, 95, 95, 92, 118, 135, 124,
    121, 124, 118, 101, 76, 73, 70, 64, 67, 73,
    67, 76, 78, 90, 115, 115, 118, 112, 115, 121,
    115, 118, 115, 112, 118, 121, 121, 121, 124, 121,
    121, 118, 124, 118, 121, 126, 126, 121, 126, 126,
    124, 126, 124, 126, 126, 126, 126, 129, 129, 129,
    129, 132, 132, 129, 129, 129, 132, 132, 129, 129,
    132, 132, 132, 129, 135, 135, 132, 132, 135, 135,
    138, 132, 135, 135, 135, 138, 132, 138, 135, 135,
    132, 138, 140, 135, 135, 135, 138, 132, 135, 143,
    138, 138, 138, 143, 138, 138, 143, 138, 140, 138,
    140, 143, 140, 140, 138, 143, 140, 143, 140, 140,
    149, 143, 143, 135, 129, 135, 132, 135, 132, 138,
    135, 135, 138, 135, 135, 135, 140, 135, 140, 140,
    138, 140, 138, 140, 135, 135, 138, 138, 138, 138,
    138, 143, 140, 138, 143, 138, 140, 138, 146, 172,
    180, 172, 172, 174, 169, 174, 174, 177, 177, 174,
    177, 174, 180, 174, 174, 174, 174, 174, 172, 172,
    169, 172, 163, 163, 166, 163, 160, 233, 140, 132,
    132, 135, 140, 152, 149, 149, 146, 143, 140, 146,
    140, 140, 146, 140, 140, 143, 140, 138, 143, 140,
    138, 140, 143, 143, 140, 146, 140, 143, 140, 146,
    140, 135, 135, 126, 121, 121, 118, 115, 109, 129,
    129, 126, 87, 61, 33, 61, 47, 33, 22, 25,
    25, 30, 70, 50, 230, 214, 109, 50, 28, 28,
    28, 30, 25, 22, 19, 30, 16, 36, 104, 112,
    109, 107, 109, 109, 112, 112, 109, 109, 112, 126,
    121, 101, 98, 95, 95, 98, 98, 98, 101, 101,
    98, 104, 104, 109, 101, 101, 98, 104, 107, 115,
    121, 115, 112, 112, 112, 112, 112, 112, 112, 98,
    118, 121, 118, 121, 124, 124, 124, 124, 118, 112,
    121, 118, 118, 115, 115, 115, 112, 112, 118, 115,
    112, 109, 109, 109, 112, 109, 107, 109, 107, 104,
    104, 107, 104, 104, 104, 101, 104, 112, 118, 112,
    115, 115, 109, 121, 109, 115, 112, 115, 115, 112,
    118, 118, 115, 112, 118, 115, 115, 121, 129, 129,
    124, 115, 112, 118, 121, 118, 112, 115, 118, 124,
    138, 149, 152, 146, 143, 149, 149, 149, 146, 146,
    146, 149, 149, 146, 149, 152, 149, 146, 146, 149,
    152, 152, 149, 155, 149, 146, 155, 152, 149, 152,
    149, 152, 152, 152, 149, 152, 149, 149, 155, 149,
    146, 152, 146, 155, 152, 152, 155, 149, 152, 152,
    152, 149, 152, 152, 152, 149, 149, 155, 149, 152,
    146, 149, 146, 149, 152, 152, 146, 146, 149, 149,
    152, 149, 149, 155, 149, 152, 152, 149, 149, 149,
    152, 149, 149, 152, 152, 152, 149, 149, 152, 155,
    152, 149, 152, 152, 149, 149, 152, 152, 149, 152,
    152, 152, 152, 149, 152, 149, 149, 149, 152, 149,
    146, 149, 149, 149, 152, 149, 146, 152, 146, 143,
    143, 143, 143, 146, 143, 146, 143, 146, 146, 143,
    118, 98, 95, 98, 104, 104, 104, 107, 112, 109,
    112, 115, 115, 115, 118, 121, 124, 121, 124, 124,
    124, 124, 129, 129, 129, 129, 129, 126, 132, 138,
    135, 135, 138, 140, 140, 140, 140, 140, 146, 143,
    146, 143, 146, 143, 140, 146, 146, 146, 146, 152,
    149, 152, 152, 157, 152, 152, 152, 152, 157, 155,
    155, 155, 155, 157, 155, 157, 157, 163, 160, 160,
    163, 163, 163, 163, 163, 166, 166, 163, 166, 172,
    169, 169, 166, 169, 172, 172, 172, 172, 169, 169,
    172, 174, 172, 174, 172, 172, 177, 174, 177, 177,
    174, 174, 177, 180, 177, 180, 180, 177, 177, 180,
    180, 177, 177, 177, 183, 180, 183, 183, 180, 180,
    180, 186, 183, 177, 180, 186, 177, 183, 183, 186,
    186, 186, 183, 186, 180, 183, 188, 183, 169, 107,
    90, 101, 115, 118, 121, 115, 95, 0, 87, 107,
    115, 109, 81, 50, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 25, 33, 30, 53,
    98, 143, 157, 155, 160, 157, 155, 160, 157, 155,
    157, 155, 160, 157, 152, 121, 135, 143, 135, 126,
    112, 109, 0, 138, 143, 140, 0, 0, 104, 70,
    107
  };
  for (int index = 0; index < TIM571_DATA_COUNT; index++) {
    rssi[index] = dump[index];
  }
}

void create_test_config(segment_config *config)
{
  config->max_distance_error = 10.0;
  config->min_points_segment = 5;
  config->max_points_skip = 5;
  config->bad_rssi = 0;
}

void create_test_lines_data(lines_data *lines)
{
  lines->count = 4;

  lines->lines[0].line.distance = 880;
  lines->lines[0].line.angle = 228;
  lines->lines[0].votes = 190;

  lines->lines[1].line.distance = 2219;
  lines->lines[1].line.angle = 45;
  lines->lines[1].votes = 178;

  lines->lines[2].line.distance = 2589;
  lines->lines[2].line.angle = 316;
  lines->lines[2].votes = 174;

  lines->lines[3].line.distance = 3184;
  lines->lines[3].line.angle = 138;
  lines->lines[3].votes = 168;
}

int main(int argc,char **argv)
{
  uint16_t distance[TIM571_DATA_COUNT];
  uint8_t rssi[TIM571_DATA_COUNT];
  tim571_status_data test_data;
  segment_config config;
  lines_data lines;
  segments_data result;

  create_test_status_data(&test_data);
  create_test_config(&config);
  create_test_distance(distance);
  create_test_rssi(rssi);
  create_test_lines_data(&lines);

  segment_transform_points_and_lines_to_segments(&config, &test_data, distance, rssi, &lines, &result);
  segment_print_segments_data(&result);
  exit(0);
}
